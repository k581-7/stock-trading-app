<%# <meta http-equiv="refresh" content="15"> %>
<style>
  /* Base */
  .portfolio-dashboard{background:#0A0F1E;min-height:100vh;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
  .page-title{display:flex;align-items:center;gap:.75rem}
  .muted{color:#6B7280}

  /* Cards / sections */
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.25rem}
  .stat-card,.section-card{background:linear-gradient(135deg,#1E293B 0%,#0F172A 100%);border:1px solid #1E293B;border-radius:1rem;position:relative}
  .stat-card{padding:1.25rem 1.5rem}
  .section-card{padding:1.25rem 1.25rem}
  .stat-label{color:#94A3B8;font-weight:500;margin-bottom:.35rem}
  .stat-value{font-weight:700;font-size:1.4rem}
  .text-blue{color:#3B82F6}
  .text-green{color:#22C55E}
  .text-red{color:#EF4444}
  .text-infoish{color:#38BDF8}

  /* Forms / buttons */
  .form-field{margin-bottom:1rem}
  .form-label{display:block;margin-bottom:.5rem;color:#E5E7EB;font-weight:500}
  .form-input{width:100%;background:#0B1220;border:1px solid #1F2937;color:#fff;border-radius:.5rem;padding:.625rem .75rem}
  .form-input:focus{outline:none;border-color:#3B82F6;box-shadow:0 0 0 2px rgba(59,130,246,0.2)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border:none;border-radius:.75rem;padding:.75rem 1rem;font-weight:700;cursor:pointer;transition:background .2s,opacity .2s;width:100%}
  .btn-green{background:#059669;color:#fff}.btn-green:hover{background:#047857}
  .btn-red{background:#DC2626;color:#fff}.btn-red:hover{background:#B91C1C}

  /* Two-column action layout */
  .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.25rem}

  /* ---- Table-like trading history ---- */
  .th-row{background:#0B1322;border:1px solid #202A3A;border-radius:.9rem;padding:1rem 1.1rem}
  .th-row + .th-row{margin-top:.8rem}
  .th-grid{display:grid;grid-template-columns:1fr auto;gap:1rem;align-items:center}
  .th-left .top{display:flex;align-items:center;gap:.55rem;margin-bottom:.35rem}
  .th-ic{font-size:1.05rem}
  .th-badge{display:inline-block;padding:.2rem .55rem;border-radius:.45rem;font-size:.72rem;font-weight:700;letter-spacing:.02em}
  .th-badge-dep{background:#0EA5E9;color:#06202B}
  .th-badge-wdr{background:#F59E0B;color:#1B1303}
  .th-time{color:#9aa4b2}
  .th-right{text-align:right}
  .th-amt{font-weight:800}
  .th-bal{color:#9aa4b2}
</style>

<div class="portfolio-dashboard container-fluid">
  <div class="container py-4" style="max-width:1300px;">

    <!-- Header -->
    <div class="mb-4 page-title">
      <i class="bi bi-wallet2" style="font-size:1.6rem;"></i>
      <div>
        <h2 class="fw-bold m-0">Wallet</h2>
        <div class="muted">Manage funds and review activity</div>
      </div>
    </div>

    <!-- Summary metrics -->
    <div class="stats-grid mb-4">
      <div class="stat-card">
        <div class="stat-label">Available Balance</div>
        <div class="stat-value text-green"><%= number_to_currency(@wallet.balance) %></div>
        <div class="muted">Ready to trade</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Deposits</div>
        <div class="stat-value text-blue"><%= number_to_currency(@wallet.total_deposits) %></div>
        <div class="muted">All time</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Trading Volume</div>
        <div class="stat-value text-infoish"><%= number_to_currency(@wallet.trading_volume) %></div>
        <div class="muted">Total traded</div>
      </div>
    </div>

    <!-- Top Up & Withdraw -->
    <div class="grid-2 mb-4">
      <!-- Top Up -->
      <div class="section-card">
        <h5 class="fw-semibold mb-3"><i class="bi bi-plus-circle me-2"></i>Top Up</h5>
        <%= form_with url: top_up_wallet_path, method: :post, local: true do %>
          <div class="form-field">
            <label class="form-label" for="amount_top_up">Amount</label>
            <%= number_field_tag :amount, nil, step: "0.01", min: "0.01", id: "amount_top_up", class: "form-input", required: true %>
          </div>
          <button class="btn btn-green"><i class="bi bi-arrow-left-right"></i> + Top Up</button>
        <% end %>
      </div>

      <!-- Withdraw -->
      <div class="section-card">
        <h5 class="fw-semibold mb-3"><i class="bi bi-dash-circle me-2"></i>Withdraw</h5>
        <%= form_with url: withdraw_wallet_path, method: :post, local: true do |f| %>
          <div class="form-field">
            <label class="form-label" for="wallet_amount_withdraw">Amount</label>
            <%= f.number_field :amount, step: 0.01, min: "0.01", id: "wallet_amount_withdraw", class: "form-input", required: true %>
          </div>
          <button class="btn btn-red"><i class="bi bi-arrow-left-right"></i> Withdraw</button>
        <% end %>
      </div>
    </div>

   <!-- Trading History -->
<div class="section-card">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="fw-semibold m-0">Wallet History (<%= @wallet_logs.count %>)</h5>
    <small class="muted">All account transactions</small>
  </div>

  <style>
    .th-row{background:#0B1322;border:1px solid #202A3A;border-radius:.9rem;padding:1rem 1.1rem}
    .th-row + .th-row{margin-top:.8rem}
    .th-grid{display:grid;grid-template-columns:1fr auto;gap:1rem;align-items:center}
    .th-left .top{display:flex;align-items:center;gap:.55rem;margin-bottom:.35rem}
    .th-ic{font-size:1.05rem}
    .th-badge{display:inline-block;padding:.2rem .55rem;border-radius:.45rem;font-size:.72rem;font-weight:700;letter-spacing:.02em}
    .th-badge-dep{background:#3B82F6;color:#fff}
    .th-badge-wdr{background:#F59E0B;color:#fff}
    .th-time{color:#9aa4b2}
    .th-right{text-align:right}
    .th-amt{font-weight:800}
    .th-bal{color:#9aa4b2}
  </style>

  <div>
    <% @wallet_logs.each do |log| %>
      <% type = log.transaction_type %>

      <% icon_class, amount_sign, amount_class, badge_html, description =
        case type
        when "deposit"
          ["bi bi-arrow-up-circle-fill text-success", "+", "text-success",
           '<span class="th-badge th-badge-dep">DEPOSIT</span>', "Deposit of #{number_to_currency(log.amount.abs)} via bank transfer"]
        when "sell"
          ["bi bi-arrow-up-circle-fill text-success", "+", "text-success",
           '<span class="th-badge th-badge-dep">SELL</span>', "Sale of #{number_to_currency(log.amount.abs)} via trading"]
        when "withdraw"
          ["bi bi-arrow-down-circle-fill text-danger", "−", "text-danger",
           '<span class="th-badge th-badge-wdr">WITHDRAW</span>', "Withdraw of #{number_to_currency(log.amount.abs)} via bank transfer"]
        when "buy"
          ["bi bi-arrow-down-circle-fill text-danger", "−", "text-danger",
           '<span class="th-badge th-badge-wdr">BUY</span>', "Buy of #{number_to_currency(log.amount.abs)} via trading"]
        else
          ["bi bi-question-circle-fill text-secondary", "", "text-secondary",
           '<span class="th-badge" style="background:#374151;color:#e5e7eb">OTHER</span>', "Processed transaction"]
        end %>

      <% ts = log.created_at.in_time_zone("Asia/Manila") %>

      <div class="th-row">
        <div class="th-grid">
          <!-- LEFT -->
          <div class="th-left">
            <div class="top">
              <i class="<%= icon_class %> th-ic"></i>
              <%= badge_html.html_safe %>
            </div>
            <div class="th-time"><%= ts.strftime("%b %d, %Y %I:%M %p") %></div>
            <div class="muted"><%= description %></div>
          </div>

          <!-- RIGHT -->
          <div class="th-right">
            <div class="th-amt <%= amount_class %>">
              <%= amount_sign %><%= number_to_currency(log.amount.abs) %>
            </div>
            <div class="th-bal">Balance: <%= number_to_currency(log.wallet&.balance || 0) %></div>
          </div>
        </div>
      </div>
    <% end %>
  </div>
</div>
