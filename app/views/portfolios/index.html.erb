<%# <meta http-equiv="refresh" content="15"> %>
<style>
  /* Base Styles - Minimal Custom CSS needed to maintain dark theme look */
  .portfolio-dashboard {
    background: #0A0F1E;
    min-height: 100vh;
    color: #fff;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }
  /* Utility Class Overrides (Shortened Custom CSS) */
  .portfolio-subtitle, .last-updated, .stat-change, .data-label, .holdings-count {
    color: #6B7280; /* Neutral text color */
  }
  .portfolio-title {
    display: flex;
    align-items: center;
    gap: 1rem;
  }
  /* Primary Button Style (Kept custom for exact color/look) */
  .refresh-btn {
    background: #2563EB;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 500;
    transition: background 0.2s;
  }
  .refresh-btn:hover { background: #1D4ED8; }
  /* Stats Grid Layout (Essential custom style) */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
  }
  /* Card Styles (Essential custom style for gradient and border) */
  .stat-card, .holdings-section {
    background: linear-gradient(135deg, #1E293B 0%, #0F172A 100%);
    border-radius: 1rem;
    border: 1px solid #1E293B;
    position: relative;
    overflow: hidden;
  }
  .stat-card { padding: 1.5rem; }
  .holdings-section { padding: 1.5rem; }
  /* Card Pseudo-element */
  .stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, rgba(59, 130, 246, 0.1) 0%, transparent 70%);
  }
  /* Icons and Colors */
  .stat-icon {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
  }
  .icon-blue { background: rgba(59, 130, 246, 0.15); color: #3B82F6; }
  .icon-green { background: rgba(34, 197, 94, 0.15); color: #22C55E; }
  .positive { color: #22C55E; } /* Green */
  .negative { color: #EF4444; } /* Red */
  .status-open { color: #22C55E; font-weight: 500; }
  .status-closed { color: #6B7280; font-weight: 500; }
  .text-highlight-blue { color: #3B82F6; }
  /* Buttons (Kept custom to maintain original design, using d-flex for icons) */
  .trade-btn, .sell-btn, .broker-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.2s;
  }
  .trade-btn { background: #059669; color: white; border: none; padding: 0.5rem 1.25rem; border-radius: 0.5rem; }
  .trade-btn:hover { background: #047857; color: white; }
  .sell-btn { background: transparent; color: #FBBF24; border: 1px solid #FBBF24; padding: 0.5rem 1rem; border-radius: 0.375rem; font-size: 0.875rem; gap: 0.25rem; }
  .sell-btn:hover { background: #FBBF24; color: #0A0F1E; }
  .broker-btn { background: transparent; color: #22C55E; border: 1px solid #22C55E; padding: 0.75rem 1.5rem; border-radius: 0.5rem; }
  .broker-btn:hover { background: #22C55E; color: #0A0F1E; }
  .broker-section { text-align: right; margin-top: 1.5rem; }
  /* Table Custom Styles (Essential for specific row separation/radius look) */
  .holdings-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 0.5rem; /* Gap between rows */
  }
  .holdings-table thead th {
    color: #94A3B8;
    font-weight: 500;
    font-size: 0.85rem;
    text-align: left;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid #1E293B;
  }
  .holdings-table tbody tr { background: #0F172A; transition: background 0.2s; }
  .holdings-table tbody tr:hover { background: #1E293B; }
  .holdings-table tbody td {
    padding: 1.25rem 1rem;
    border-top: 1px solid #1E293B;
    border-bottom: 1px solid #1E293B;
  }
  .holdings-table tbody td:first-child { border-left: 1px solid #1E293B; border-top-left-radius: 0.5rem; border-bottom-left-radius: 0.5rem; }
  .holdings-table tbody td:last-child { border-right: 1px solid #1E293B; border-top-right-radius: 0.5rem; border-bottom-right-radius: 0.5rem; }
  /* Data Info Layouts (Using Bootstrap fw-semibold for font-weight) */
  .stock-info, .data-info {
    display: flex;
    flex-direction: column;
  }
  .stock-symbol, .data-value {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }
  .alert-success {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid #22C55E;
    color: #22C55E;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-top: 1rem;
  }

    .dark-input {
    background-color: #1E293B; /* slightly lighter than table bg (#0F172A) */
    border: 1px solid #334155; /* subtle border */
    color: #F1F5F9; /* light gray text */
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
  }

  .dark-input:focus {
    background-color: #0F172A; /* even darker on focus */
    border-color: #3B82F6;     /* blue highlight border */
    outline: none;
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4);
  }
</style>
<div class="portfolio-dashboard container-fluid">
  <div class="container py-4" style="max-width: 1300px;">
    <% total_value = @portfolios.sum { |p| p.stock&.current_price.to_f * p.quantity.to_f } %>
    <% total_gain_loss = @portfolios.sum { |p| (p.stock&.price_change.to_f) * p.quantity.to_f } %>
    <% total_return = total_value > 0 ? (total_gain_loss / total_value) * 100 : 0 %>
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div class="portfolio-title">
        <i class="bi bi-briefcase-fill" style="font-size: 2rem;"></i>
        <div>
          <h1 class="fs-4 fw-bold m-0">My Portfolio</h1>
          <p class="portfolio-subtitle mb-0">Get snapshot of your current stock holdings and their market value</p>
        </div>
      </div>
      <div class="d-flex align-items-center gap-3">
      </div>
    </div>
    <div class="stats-grid mb-4">
      <div class="stat-card">
        <div class="stat-label">Total Portfolio Value</div>
        <div class="stat-value text-highlight-blue"><%= number_to_currency(total_value) %></div>
        <div class="stat-change">Combined value of all holdings</div>
        <div class="stat-icon icon-blue">
          <i class="bi bi-currency-dollar"></i>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Gain/Loss</div>
        <div class="stat-value <%= total_gain_loss >= 0 ? 'positive' : 'negative' %>">
          <%= total_gain_loss >= 0 ? '+' : '' %><%= number_to_currency(total_gain_loss) %>
        </div>
        <div class="stat-change">Compared to purchase price (unrealized)</div>
        <div class="stat-icon <%= total_gain_loss >= 0 ? 'icon-green' : 'icon-blue' %>">
          <i class="bi bi-graph-up"></i>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Return</div>
        <div class="stat-value <%= total_return >= 0 ? 'positive' : 'negative' %>">
          <%= total_return >= 0 ? '+' : '' %><%= number_with_precision(total_return, precision: 2) %>%
        </div>
        <div class="stat-change">Percentage gain/loss</div>
        <div class="stat-icon <%= total_return >= 0 ? 'icon-green' : 'icon-blue' %>">
          <i class="bi bi-percent"></i>
        </div>
      </div>
    </div>
    <div class="holdings-section mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-3">
        <div>
          <h2 class="fs-5 fw-semibold mb-1">
            <i class="bi bi-bar-chart-fill"></i> Current Holdings <span class="holdings-count">(<%= @portfolios.count %>)</span>
          </h2>
          <p class="holdings-description mb-0">Monitor your stock-by-stock gains, gains total, diverse investment portfolio.</p>
        </div>
        <%= link_to new_trade_path, class: "trade-btn" do %>
          <i class="bi bi-arrow-left-right"></i> Trade
        <% end %>
      </div>
    <div class="table-responsive">
      <table class="holdings-table">
        <thead>
          <tr>
            <th>Stock</th>
            <th>Shares Owned</th>
            <th>Current Price</th>
            <th>Price Change</th>
            <th>% Change</th>
            <th>Market Value</th>
            <th>Last Updated</th> <!-- :white_check_mark: New column -->
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody>
          <% @portfolios.each do |p| %>
            <% live_price = p.stock.current_price.to_f %>
            <% market_value = live_price * p.quantity.to_f %>
            <% last_updated = p.stock.last_updated_at || p.stock.updated_at %>
            <tr>
              <td>
                <div class="stock-info">
                  <div class="stock-symbol"><%= p.stock.symbol %></div>
                </div>
              </td>
              <td>
                <div class="data-info">
                  <div class="data-value"><%= p.quantity %></div>
                </div>
              </td>
              <td>
                <div class="data-info">
                  <div class="data-value text-highlight-blue"><%= number_to_currency(live_price) %></div>
                </div>
              </td>
              <td>
                <div class="data-info <%= p.stock.price_change.to_f >= 0 ? 'positive' : 'negative' %>">
                  <div class="data-value">
                    <%= p.stock.price_change.to_f >= 0 ? '▲ +' : '▼ ' %>
                    <%= number_with_precision(p.stock.price_change, precision: 2) %>
                  </div>
                </div>
              </td>
              <td>
                <div class="data-info <%= p.stock.percent_change.to_f >= 0 ? 'positive' : 'negative' %>">
                  <div class="data-value">
                    <%= p.stock.percent_change.to_f >= 0 ? '▲ +' : '▼ ' %>
                    <%= number_with_precision(p.stock.percent_change, precision: 2) %>%
                  </div>
                </div>
              </td>
              <td>
                <div class="data-info">
                  <div class="data-value"><%= number_to_currency(market_value) %></div>
                </div>
              </td>
              <!-- :white_check_mark: New Last Updated column -->
              <td>
                <div class="data-info">
                  <div class="data-value">
                    <% if last_updated %>
                      <%= last_updated.in_time_zone("Asia/Manila").strftime("%b. %-d, %Y %I:%M%p") %>
                    <% else %>
                      N/A
                    <% end %>
                  </div>
                </div>
              </td>
              <td>
                <div class="data-info">
                  <div class="<%= p.stock.market_open ? 'status-open' : 'status-closed' %>">
                    <%= p.stock.market_open ? '● Open' : '○ Closed' %>
                  </div>
                </div>
              </td>
              <td>
                <% if current_user.broker_status == "broker_approved" %>
                  <%= form_with url: sell_portfolio_path(p), method: :post, local: true do |f| %>
                    <div class="d-flex align-items-center gap-2">
                      <!-- Input field for quantity -->
                      <%= number_field_tag :quantity, 1, min: 1, max: p.quantity, class: "form-control form-control-sm dark-input", style: "width:70px;" %>

                      <!-- Sell button -->
                      <%= f.button type: "submit", class: "btn btn-sm btn-warning d-flex align-items-center" do %>
                        <i class="bi bi-currency-dollar me-1"></i> Sell
                      <% end %>
                    </div>
                  <% end %>
                <% else %>
                  <button class="btn btn-sm btn-secondary d-flex align-items-center" disabled>
                    <i class="bi bi-lock me-1"></i> Sell (Broker Only)
                  </button>
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
    <div class="broker-section">
      <% if current_user.broker_status != "broker_approved" %>
        <%= button_to apply_broker_user_path(current_user),
            method: :patch, class: "broker-btn" do %>
          <i class="bi bi-person-workspace"></i> Apply to be a Broker
        <% end %>
      <% end %>
    </div>
  </div>
</div>