<%# <meta http-equiv="refresh" content="15"> %>
<style>
  /* Base */
  .portfolio-dashboard{background:#0A0F1E;min-height:100vh;color:#fff;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
  .page-title{display:flex;align-items:center;gap:.75rem}
  .muted{color:#6B7280}

  /* Cards / sections */
  .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.25rem}
  .stat-card,.section-card{background:linear-gradient(135deg,#1E293B 0%,#0F172A 100%);border:1px solid #1E293B;border-radius:1rem;position:relative}
  .stat-card{padding:1.25rem 1.5rem}
  .section-card{padding:1.25rem 1.25rem}
  /* remove any glow */
  .stat-card::before,.section-card::before{content:none}

  .stat-label{color:#94A3B8;font-weight:500;margin-bottom:.35rem}
  .stat-value{font-weight:700;font-size:1.4rem}
  .text-blue{color:#3B82F6}
  .text-green{color:#22C55E}
  .text-red{color:#EF4444}
  .text-infoish{color:#38BDF8}

  /* Forms / buttons */
  .form-field{margin-bottom:1rem}
  .form-label{display:block;margin-bottom:.5rem;color:#E5E7EB;font-weight:500}
  .form-input{width:100%;background:#0B1220;border:1px solid #1F2937;color:#fff;border-radius:.5rem;padding:.625rem .75rem}
  .form-input:focus{outline:none;border-color:#3B82F6;box-shadow:0 0 0 2px rgba(59,130,246,0.2)}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;border:none;border-radius:.75rem;padding:.75rem 1rem;font-weight:700;cursor:pointer;transition:background .2s,opacity .2s;width:100%}
  .btn-green{background:#059669;color:#fff}.btn-green:hover{background:#047857}
  .btn-red{background:#DC2626;color:#fff}.btn-red:hover{background:#B91C1C}

  /* Two-column action layout */
  .grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1.25rem}

  /* History rows */
  .history-list{display:flex;flex-direction:column;gap:.75rem}
  .history-row{background:#0F172A;border:1px solid #1E293B;border-radius:.75rem;padding:1rem}
  .row-top{display:flex;align-items:center;gap:.5rem;margin-bottom:.35rem}
  .pill{display:inline-block;background:#111827;color:#E5E7EB;border:1px solid #2B3545;padding:.25rem .5rem;border-radius:.5rem;font-size:.75rem;text-transform:uppercase;letter-spacing:.02em}
  .icon{font-size:1.1rem}
  .row-grid{display:grid;grid-template-columns:1fr auto;gap:1rem;align-items:center}
  .right-info{text-align:right}
  .right-info .amount{font-weight:700}
  .badge{display:inline-block;border-radius:.5rem;padding:.15rem .5rem;font-size:.75rem}
  .badge-info{background:#0EA5E9;color:#06202B}
  .badge-warn{background:#F59E0B;color:#1B1303}
</style>

<div class="portfolio-dashboard container-fluid">
  <div class="container py-4" style="max-width:1300px;">

    <!-- Header -->
    <div class="mb-4 page-title">
      <i class="bi bi-wallet2" style="font-size:1.6rem;"></i>
      <div>
        <h2 class="fw-bold m-0">Wallet</h2>
        <div class="muted">Manage funds and review activity</div>
      </div>
    </div>

    <!-- Summary metrics -->
    <div class="stats-grid mb-4">
      <div class="stat-card">
        <div class="stat-label">Available Balance</div>
        <div class="stat-value text-green"><%= number_to_currency(@wallet.balance) %></div>
        <div class="muted">Ready to trade</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Deposits</div>
        <div class="stat-value text-blue"><%= number_to_currency(@wallet.total_deposits) %></div>
        <div class="muted">All time</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Trading Volume</div>
        <div class="stat-value text-infoish"><%= number_to_currency(@wallet.trading_volume) %></div>
        <div class="muted">Total traded</div>
      </div>
    </div>

    <!-- Top Up & Withdraw -->
    <div class="grid-2 mb-4">
      <!-- Top Up -->
      <div class="section-card">
        <h5 class="fw-semibold mb-3"><i class="bi bi-plus-circle me-2"></i>Top Up</h5>
        <%= form_with url: top_up_wallet_path, method: :post, local: true do %>
          <div class="form-field">
            <label class="form-label" for="amount_top_up">Amount</label>
            <%= number_field_tag :amount, nil, step: "0.01", min: "0.01", id: "amount_top_up", class: "form-input", required: true %>
          </div>
          <button class="btn btn-green"><i class="bi bi-arrow-left-right"></i> + Top Up</button>
        <% end %>
      </div>

      <!-- Withdraw -->
      <div class="section-card">
        <h5 class="fw-semibold mb-3"><i class="bi bi-dash-circle me-2"></i>Withdraw</h5>
        <%= form_with url: withdraw_wallet_path, method: :post, local: true do |f| %>
          <div class="form-field">
            <label class="form-label" for="wallet_amount_withdraw">Amount</label>
            <%= f.number_field :amount, step: 0.01, min: "0.01", id: "wallet_amount_withdraw", class: "form-input", required: true %>
          </div>
          <button class="btn btn-red"><i class="bi bi-arrow-left-right"></i> Withdraw</button>
        <% end %>
      </div>
    </div>

    <!-- Wallet Activity -->
    <div class="section-card">
      <h5 class="fw-semibold mb-3">Wallet Activity <span class="muted">(<%= @wallet_logs.count %>)</span></h5>

      <div class="history-list">
        <% @wallet_logs.each do |log| %>
          <% type = log.transaction_type %>
          <% icon_class =
            case type
            when "buy"      then "bi bi-arrow-up-circle-fill text-green"
            when "sell"     then "bi bi-arrow-down-circle-fill text-red"
            when "deposit"  then "bi bi-arrow-up-circle-fill text-infoish"
            when "withdraw" then "bi bi-arrow-down-circle-fill text-red"
            else "bi bi-question-circle-fill text-secondary"
            end %>

          <% badge_html =
            case type
            when "deposit"  then '<span class="badge badge-info">DEPOSIT</span>'
            when "withdraw" then '<span class="badge badge-warn">WITHDRAW</span>'
            when "buy"      then '<span class="pill">BUY</span>'
            when "sell"     then '<span class="pill">SELL</span>'
            else                 '<span class="pill">OTHER</span>'
            end.html_safe %>

          <% amount_sign = log.amount >= 0 ? '+' : '-' %>
          <% amount_class = log.amount >= 0 ? 'text-green' : 'text-red' %>
          <% ts = log.created_at.in_time_zone("Asia/Manila") %>

          <div class="history-row">
            <div class="row-grid">
              <!-- Left -->
              <div>
                <div class="row-top">
                  <i class="<%= icon_class %> icon"></i>
                  <strong style="text-transform:uppercase"><%= type %></strong>
                  <%= badge_html %>
                </div>
                <div class="muted">
                  <%= ts.strftime("%b %d, %Y %I:%M %p") %><br>
                  <%= "#{type.capitalize} of #{number_to_currency(log.amount.abs)} via bank transfer" %>
                </div>
              </div>

              <!-- Right -->
              <div class="right-info">
                <div class="amount <%= amount_class %>"><%= amount_sign %><%= number_to_currency(log.amount.abs) %></div>
                <small class="muted d-block">Action: <%= type %></small>
                <small class="muted d-block">Balance: <%= number_to_currency(log.wallet&.balance || 0) %></small>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    </div>

  </div>
</div>
